!function(e){var t={};function r(o){if(t[o])return t[o].exports;var n=t[o]={i:o,l:!1,exports:{}};return e[o].call(n.exports,n,n.exports,r),n.l=!0,n.exports}r.m=e,r.c=t,r.d=function(e,t,o){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(r.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)r.d(o,n,function(t){return e[t]}.bind(null,n));return o},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=0)}([function(e,t,r){"use strict";r.r(t);var o={"*compose":"c","+delete":"d","+input":"i",markText:"k",select:"l","*mouse":"m","*rename":"n","+move":"o",paste:"p",drag:"r",setValue:"s",cut:"x"},n=function(e){return o[e]};function i(e){return e.from.line===e.to.line&&e.from.ch===e.to.ch?[e.from.line,e.from.ch]:[[e.from.line,e.from.ch],[e.to.line,e.to.ch]]}function s(e,t){if(e.ops.length!==t.ops.length)return!1;for(var r=0;r<t.ops.length;r++){var o=e.ops[r],n=t.ops[r];if(n.from.line!==n.to.line||o.from.line!==o.to.line||n.from.ch!==n.to.ch||o.from.ch!==o.to.ch)return!1;if(o.from.ch+o.text[0].length!==n.from.ch)return!1}return!0}var a={acceptableMinOperationDelay:1200,acceptableMinCursorMoveDelay:600};function l(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;if(e.crs.length!==t.crs.length)return!1;if(t.delayDuration>=a.acceptableMinCursorMoveDelay)return!1;for(var o=0;o<t.crs.length;o++){var n=e.crs[o],i=t.crs[o];if(n.anchor.line!==n.head.line||n.anchor.ch!==n.head.ch)return!1;if(e.crs[o].anchor.ch+r!==i.anchor.ch)return!1;if(e.crs[o].anchor.line!==i.anchor.line)return!1}return!0}function u(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=[];e.length>0;){var o=e.pop();if("crs"in o){for(;e.length>0;){var n=e.pop();if(!("crs"in n&&l(n,o,t))){e.push(n);break}o.startTime=n.startTime,o.delayDuration=n.delayDuration,o.combo+=1;for(var i=0;i<o.crs.length;i++)o.crs[i].anchor=n.crs[i].anchor}r.unshift(o)}else r.unshift(o)}return r}function h(e,t){if(e.ops.length!==t.ops.length)return!1;if(t.delayDuration>=a.acceptableMinOperationDelay)return!1;for(var r=0;r<t.ops.length;r++){var o=e.ops[r],n=t.ops[r];if(n.from.line!==n.to.line||o.from.line!==o.to.line||n.from.ch!==n.to.ch||o.from.ch!==o.to.ch)return!1;if(o.from.ch+1!==n.from.ch&&(o.from.line+1!==n.from.line||0!==n.from.ch))return!1}return!0}function c(e){for(var t=0;t<e.ops.length;t++){for(var r="",o=0;o<e.ops[t].text.length;o++)""!==e.ops[t].text[o]?r+=e.ops[t].text[o]:o+1<e.ops[t].text.length&&""===e.ops[t].text[o+1]&&(r+="\n",o++);e.ops[t].text=r}return e}function f(e,t){if(e.crs.length!==t.crs.length)return!1;for(var r=0;r<t.crs.length;r++){var o=e.crs[r],n=t.crs[r];if(n.anchor.line===n.head.line&&n.anchor.ch===n.head.ch)return!1;if(o.anchor.line!==n.anchor.line||o.anchor.ch!==n.anchor.ch)return!1}return!0}function p(e){for(var t=[],r=-1;e.length>0;){var o=e.shift();r!==o.line&&(t.push([o.line]),r=o.line),t[t.length-1].push(o.ch)}for(var n=0;n<t.length;n++){var i=t[n].slice(1);i=v(i),i=v(i,-1),t[n]=[t[n][0],i]}return t}function v(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=[];e.length>0;){var o=e.shift();"number"!=typeof o?r.push(o):0===r.length||Array.isArray(r[r.length-1])?r.push({from:o,to:o}):"to"in r[r.length-1]&&(r[r.length-1].to+t!==o?r.push({from:o,to:o}):r[r.length-1].to=o)}for(var n=0;n<r.length;n++)"to"in r[n]&&(r[n].from===r[n].to?r[n]=r[n].from:r[n]=[r[n].from,r[n].to]);return r}function g(e,t){if(e.ops.length!==t.ops.length)return!1;if(t.delayDuration>=a.acceptableMinOperationDelay)return!1;for(var r=0;r<t.ops.length;r++){var o=e.ops[r],n=t.ops[r];if(o.from.ch!==n.to.ch||o.from.line!==n.to.line)return!1}return!0}function m(e){if(1===e.combo)return e;for(var t=0;t<e.ops.length;t++){for(var r=[],o=[];e.ops[t].removed.length>0;){var n=e.ops[t].removed.shift();"string"==typeof n?0===o.length?o.push(n):o[0].length===n.length?o.push(n):(r.push([o[0].length,o.length]),(o=[]).push(n)):(o.length>0&&(r.push([o[0].length,o.length]),o=[]),r.push([[n[0].line,n[0].ch],[n[1].line,n[1].ch]]))}o.length>0&&r.push([o[0].length,o.length]),e.ops[t].removed=r}return e}var d=function(e){return function(e){for(var t=[];e.length>0;){var r=e.pop();if("*compose"===r.ops[0].origin){for(;e.length>0;){var o=e.pop();if("*compose"!==o.ops[0].origin||!s(o,r)){e.push(o);break}r.startTime=o.startTime,r.delayDuration=o.delayDuration,r.combo+=1;for(var n=0;n<r.ops.length;n++)r.ops[n].from=o.ops[n].from,r.ops[n].to=o.ops[n].to,r.ops[n].text=o.ops[n].text.concat(r.ops[n].text)}t.unshift(r)}else t.unshift(r)}return t}(e)},y=function(e){return e=u(e,1),e=function(e){for(var t=0;t<e.length;t++)if("crs"in e[t]){e[t].ops=[];for(var r=0;r<e[t].crs.length;r++)e[t].ops.push({from:e[t].crs[r].anchor,to:e[t].crs[r].head,origin:"+move",text:[""],removed:[""]});delete e[t].crs}return e}(e=u(e,-1))},b=function(e){return function(e){for(var t=[];e.length>0;){var r=e.pop();if("+input"===r.ops[0].origin){for(;e.length>0;){var o=e.pop();if("+input"!==o.ops[0].origin||!h(o,r)){e.push(o);break}r.startTime=o.startTime,r.delayDuration=o.delayDuration,r.combo+=1;for(var n=0;n<r.ops.length;n++)r.ops[n].from=o.ops[n].from,r.ops[n].to=o.ops[n].to,r.ops[n].text=o.ops[n].text.concat(r.ops[n].text)}r=c(r),t.unshift(r)}else t.unshift(r)}return t}(e)},T=function(e){return e=function(e){for(var t=0;t<e.length;t++)if("crs"in e[t]&&e[t].combo>1){e[t].ops=[];for(var r=0;r<e[t].crs.length;r++)e[t].ops.push({from:e[t].crs[r].anchor,to:e[t].crs[r].anchor,origin:"select",text:[""],removed:[""],select:p(e[t].crs[r].heads)});delete e[t].crs}return e}(e=function(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1];for(var t=[];e.length>0;){var r=e.pop();if("crs"in r){for(;e.length>0;){var o=e.pop();if(!("crs"in o&&f(o,r))){e.push(o);break}r.startTime=o.startTime,r.delayDuration=o.delayDuration,r.combo+=1;for(var n=0;n<r.crs.length;n++)"heads"in r.crs[n]?r.crs[n].heads.unshift(o.crs[n].head):r.crs[n].heads=[o.crs[n].head,r.crs[n].head]}t.unshift(r)}else t.unshift(r)}return t}(e))},O=function(e){return function(e){for(var t=[];e.length>0;){var r=e.pop();if("+delete"===r.ops[0].origin){for(;e.length>0;){var o=e.pop();if("+delete"!==o.ops[0].origin||!g(o,r)){e.push(o);break}r.startTime=o.startTime,r.delayDuration=o.delayDuration;for(var n=0;n<r.ops.length;n++)1===r.combo&&r.ops[n].removed.length>1&&(r.ops[n].removed=[[r.ops[n].from,r.ops[n].to]]),o.ops[n].removed.length>1&&(o.ops[n].removed=[[o.ops[n].from,o.ops[n].to]]),r.ops[n].removed=r.ops[n].removed.concat(o.ops[n].removed),r.ops[n].to=o.ops[n].to;r.combo+=1}r=m(r),t.unshift(r)}else t.unshift(r)}return t}(e)};function x(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var D=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.initTime=+new Date,this.lastChangeTime=+new Date,this.lastCursorActivityTime=+new Date,this.operations=[],this.editor=t,this.changesListener=this.changesListener.bind(this),this.cursorActivityListener=this.cursorActivityListener.bind(this)}var t,r,o;return t=e,(r=[{key:"listen",value:function(){this.editor.on("changes",this.changesListener),this.editor.on("cursorActivity",this.cursorActivityListener)}},{key:"getRecords",value:function(){return this.removeRedundantCursorOperations(),this.compressCursorOperations(),this.compressChanges(),JSON.stringify(function(e){for(var t,r=[];e.length>0;){for(var o=e.pop(),s=0;s<o.ops.length;s++)o.ops[s].i=i(o.ops[s]),o.ops[s].a=o.ops[s].text,o.ops[s].d=o.ops[s].removed,o.ops[s].o=n(o.ops[s].origin),1===o.ops[s].a.length&&""===o.ops[s].a[0]&&delete o.ops[s].a,1===o.ops[s].d.length&&""===o.ops[s].d[0]&&delete o.ops[s].d,"select"in o.ops[s]&&(o.ops[s].s=o.ops[s].select,delete o.ops[s].select),1===o.combo&&delete o.ops[s].d,delete o.ops[s].removed,delete o.ops[s].text,delete o.ops[s].from,delete o.ops[s].origin,delete o.ops[s].to;o.t=(t=[o.startTime,o.endTime])[0]===t[1]?t[0]:t,o.l=o.combo,o.o=o.ops,1===o.l&&delete o.l,delete o.ops,delete o.delayDuration,delete o.combo,delete o.startTime,delete o.endTime,r.unshift(o)}return r}(this.operations))}},{key:"getOperationRelativeTime",value:function(){return+new Date-this.initTime}},{key:"getLastChangePause",value:function(){var e=+new Date,t=e-this.lastChangeTime;return this.lastChangeTime=e,t}},{key:"getLastCursorActivityPause",value:function(){var e=+new Date,t=e-this.lastCursorActivityTime;return this.lastCursorActivityTime=e,t}},{key:"changesListener",value:function(e,t){this.operations.push({startTime:this.getOperationRelativeTime(),endTime:this.getOperationRelativeTime(),delayDuration:this.getLastChangePause(),ops:t,combo:1})}},{key:"cursorActivityListener",value:function(e){this.operations.push({startTime:this.getOperationRelativeTime(),endTime:this.getOperationRelativeTime(),delayDuration:this.getLastCursorActivityPause(),crs:e.listSelections(),combo:1})}},{key:"removeRedundantCursorOperations",value:function(){for(var e=this.operations,t=[],r=0;r<e.length;r++)r<e.length-1&&"ops"in e[r+1]&&!("ops"in e[r])||t.push(e[r]);this.operations=t}},{key:"compressCursorOperations",value:function(){var e=this.operations;e=T(e),e=y(e),this.operations=e}},{key:"compressChanges",value:function(){var e=this.operations;e=b(e),e=O(e),e=d(e),this.operations=e}}])&&x(t.prototype,r),o&&x(t,o),e}();function C(e){for(var t=[],r=0;r<e.length;r++)for(var o=0;o<e[r][1].length;o++)if("number"==typeof e[r][1][o])t.push([e[r][0],e[r][1][o]]);else{var n=e[r][1][o][0]<e[r][1][o][1]?1:-1,i=e[r][1][o][0];for(t.push([e[r][0],i]);i!==e[r][1][o][1];)i+=n,t.push([e[r][0],i])}return t}var k=function(e,t){var r=e.t[0],o=(e.t[1]-e.t[0])/(e.l-1),n={t:null,o:[]};n.t=Math.floor(r+t*o),t===e.l-1&&(n.t=e.t[1]),n.cursorOnly=!1;for(var i=[],s=0;s<e.o.length;s++)i.push(e.o[s].i),n.o.push({a:null,i:null});for(var a=0;a<e.o.length;a++)n.o[a].a=e.o[a].a[t],n.o[a].i=[i[a][0],i[a][1]],i[a][1]+=e.o[a].a[t].length;return n},M=function(e,t){var r=e.t[0],o=(e.t[1]-e.t[0])/(e.l-1),n={t:null,o:[]};n.t=Math.floor(r+t*o),t===e.l-1&&(n.t=e.t[1]),n.cursorOnly=!0;for(var i=[],s=0;s<e.o.length;s++)i.push(e.o[s].i),n.o.push({i:null});for(var a=0;a<e.o.length;a++){var l=i[a][0][0],u=i[a][0][1]+(i[a][1][1]-i[a][0][1])/(e.l-1)*t;n.o[a].i=[l,u]}return n},w=function(e,t){var r=e.t[0],o=(e.t[1]-e.t[0])/(e.l-1),n={t:null,o:[]};n.t=Math.floor(r+t*o),t===e.l-1&&(n.t=e.t[1]),n.cursorOnly=!1;for(var i=[],s=0;s<e.o.length;s++)i.push(e.o[s].i),n.o.push({a:null,i:null});for(var a=0;a<e.o.length;a++)n.o[a].a=e.o[a].a[t],n.o[a].i=[i[a][0],i[a][1]],"\n"!==n.o[a].a?i[a][1]++:(i[a][0]++,i[a][1]=0);return n},A=function(e,t){var r=e.t[0],o=(e.t[1]-e.t[0])/(e.l-1),n={t:null,o:[]};n.t=Math.floor(r+t*o),t===e.l-1&&(n.t=e.t[1]),n.cursorOnly=!0;for(var i=[],s=0;s<e.o.length;s++)i.push(e.o[s].i),n.o.push({i:null});for(var a=0;a<e.o.length;a++){var l=[e.o[a].i[0],e.o[a].i[1]],u=C(e.o[a].s),h=[u[t][0],u[t][1]];n.o[a].i=[l,h]}return n},L=function(e,t){var r=e.t[0],o=(e.t[1]-e.t[0])/(e.l-1),n={t:null,o:[]};n.t=Math.floor(r+t*o),t===e.l-1&&(n.t=e.t[1]),n.cursorOnly=!1;for(var i=[],s=0;s<e.o.length;s++)i.push(e.o[s].i[1]),n.o.push({i:null});for(var a=0;a<e.o.length;a++){var l=e.o[a].d.pop();"number"==typeof l[0]?(n.o[a].i=[[i[a][0],i[a][1]-l[0]],[i[a][0],i[a][1]]],i[a][1]-=l[0],l[1]-1>0&&e.o[a].d.push([l[0],l[1]-1])):(n.o[a].i=[[l[0][0],l[0][1]],[l[1][0],l[1][1]]],e.o[a].i[1]=[l[0][0],l[0][1]])}return n};function j(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var P=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.timer=0,this.operations=[],this.editor=t}var t,r,o;return t=e,(r=[{key:"addOperation",value:function(e){var t=this.parseOpertaions(e);this.operations=this.operations.concat(t),this.playChanges()}},{key:"playChanges",value:function(){var e=this;this.editor.focus();var t=this.operations;if(t.length>0){this.timer=t[0].t;for(var r=function(){var r=t.shift();setTimeout(function(){e.playChange(e.editor,r)},r.t-e.timer)};t.length>0;)r()}}},{key:"playChange",value:function(e,t){for(var r=0;r<t.o.length;r++){var o=this.insertionText(t.o[r]),n=t.o[r].i;"number"==typeof n[0]&&(n=[n,n]),e.setSelection({line:n[0][0],ch:n[0][1]},{line:n[1][0],ch:n[1][1]}),t.cursorOnly||e.replaceRange(o,{line:n[0][0],ch:n[0][1]},{line:n[1][0],ch:n[1][1]})}}},{key:"insertionText",value:function(e){var t="";return"string"==typeof e.a?t=e.a:"a"in e&&(t=e.a.join("\n")),t}},{key:"parseOpertaions",value:function(e){e=JSON.parse(e);var t=[],r=!0,o=!1,n=void 0;try{for(var i,s=e[Symbol.iterator]();!(r=(i=s.next()).done);r=!0){var a=i.value;if("l"in a)for(var l=0;l<a.l;l++)"i"===a.o[0].o?t.push(w(a,l)):"c"===a.o[0].o?t.push(k(a,l)):"d"===a.o[0].o?t.push(L(a,l)):"o"===a.o[0].o?t.push(M(a,l)):"l"===a.o[0].o&&t.push(A(a,l));else t.push(a)}}catch(e){o=!0,n=e}finally{try{r||null==s.return||s.return()}finally{if(o)throw n}}return t}}])&&j(t.prototype,r),o&&j(t,o),e}(),R=CodeMirror.fromTextArea(document.getElementById("editor-record"),{mode:"javascript"}),S=new D(R);S.listen(),document.getElementById("record").onclick=function(){console.log(S.getRecords())};var _=new P(CodeMirror.fromTextArea(document.getElementById("editor-play"),{readOnly:!0,mode:"javascript"})),E=null,B=function(){var e=S.getRecords();_.addOperation(e)};R.on("changes",function(){clearTimeout(E),E=setTimeout(B,3e3)}),R.setValue('var tes;\nlet a = "\\n\\nLOL";')}]);